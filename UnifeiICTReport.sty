% cSpell:locale en,pt-BR - Adicionado para suporte ao corretor ortográfico
% Extensão Code Spell Checker no VS Code (muito útil!)

% ------------------------------------------------------------------------
% UnifeiICTReport.sty -- formatação para relatórios técnicos-científicos do Instituto de Ciências
% Tecnológicas (ICT) da Universidade Federal de Itajubá (Unifei) Campus Itabira
%
% Autor - Prof. Dr. Wendell Fioravante da Silva Diniz
% Contato - wendelldiniz@unifei.edu.br
% Versão - 2025/10/25 v1.0
% Licença - Creative Commons 
% Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)
% ------------------------------------------------------------------------


\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{UnifeiICTReport}[2025/10/25 v0.2]
\DeclareOption{neverindent}{\@neverindenttrue}

% --- Lógica para família de fontes ---
\newif\if@roman
\DeclareOption{roman}{\@romantrue}
\DeclareOption{sans}{\@romanfalse}

% Acumula opções fornecidas ao pacote para processamento posterior
\def\UnifeiICTReport@rawopts{}
\DeclareOption*{%
    % concatena, separado por vírgula
    \ifx\UnifeiICTReport@rawopts\@empty
        \edef\UnifeiICTReport@rawopts{\CurrentOption}%
    \else
        \edef\UnifeiICTReport@rawopts{\UnifeiICTReport@rawopts,\CurrentOption}%
    \fi
}

% Defaults: roman font family (mantido) e brazilian como comportamento padrão
\ExecuteOptions{roman}
\ProcessOptions\relax

% --- Lógica para decidir quais opções de língua passar ao babel ---
% Regras implementadas:
% - Se o usuário não fornecer nenhuma língua, usamos por padrão "english,brazilian"
%   (brazilian como principal — pois vem por último)
% - Se o usuário fornecer alguma opção de língua contendo "english" ou "brazilian",
%   essas são detectadas e a prioridade é: se "english" estiver presente -> main=english;
%   senão, se "brazilian" estiver presente -> main=brazilian.
% - Se o usuário não fornecer explicitamente english/brazilian mas fornecer outra língua X,
%   essa língua será usada como main e english será secundária.
% - Em todos os casos a lista passada ao babel é: <secondary>,<main> (main vem por último).

% inicializa variáveis auxiliares
\def\UnifeiICTReport@mainlang{}
\def\UnifeiICTReport@seclang{}
\def\UnifeiICTReport@lasttok{}

% percorre opções coletadas e detecta tokens de língua,
% ignorando opções conhecidas do pacote (roman, sans, neverindent)
\@for\@opt:=\UnifeiICTReport@rawopts\do{%
    \edef\@tempa{\@opt}% normaliza token para comparação direta
    % ignore empty tokens
    \ifx\@tempa\@empty\else
        % detecta english/brazilian explicitamente
        \edef\@langE{english}\edef\@langB{brazilian}\edef\@optcmp{\@tempa}%
        \ifx\@optcmp\@langE
            \def\UnifeiICTReport@mainlang{english}%
        \else\ifx\@optcmp\@langB
                \ifx\UnifeiICTReport@mainlang\@empty
                    \def\UnifeiICTReport@mainlang{brazilian}%
                \fi
            \fi\fi
        % memorize last token seen (candidate language if none of the above)
        % but skip known non-language options
        \edef\@skipA{roman}\edef\@skipB{sans}\edef\@skipC{neverindent}%
        \ifx\@optcmp\@skipA\else\ifx\@optcmp\@skipB\else\ifx\@optcmp\@skipC\else
                    \edef\UnifeiICTReport@lasttok{\@tempa}%
                \fi\fi\fi
    \fi
}

% Decide main language
\ifx\UnifeiICTReport@mainlang\@empty
    % não detectamos explicitamente english/brazilian: se havia um token qualquer use-o
    \ifx\UnifeiICTReport@lasttok\@empty
        \def\UnifeiICTReport@mainlang{brazilian}% default
    \else
        \edef\UnifeiICTReport@mainlang{\UnifeiICTReport@lasttok}%
    \fi
\fi

% Decide secondary language segundo as regras
\edef\@langB{brazilian}\edef\@langE{english}
\ifx\UnifeiICTReport@mainlang\@langB
    \def\UnifeiICTReport@seclang{english}% if main=brazilian -> english secondary
\else\ifx\UnifeiICTReport@mainlang\@langE
        \def\UnifeiICTReport@seclang{brazilian}% if main=english -> brazilian secondary
    \else
        \def\UnifeiICTReport@seclang{english}% any other main -> english secondary
    \fi\fi

% Evita duplicação: se secondary == main, passa apenas main
\ifx\UnifeiICTReport@seclang\UnifeiICTReport@mainlang
    \edef\UnifeiICTReport@babelopts{\UnifeiICTReport@mainlang}
\else
    \edef\UnifeiICTReport@babelopts{\UnifeiICTReport@seclang,\UnifeiICTReport@mainlang}
\fi

% Finalmente passa as opções calculadas para babel e carrega o pacote
\PassOptionsToPackage{\UnifeiICTReport@babelopts}{babel}
\RequirePackage{babel}
% Note: do not \RequirePackage{heuristica} unconditionally here — prefer
% to use an OpenType installation when available or fall back to system
% serif fonts. Loading the legacy `heuristica` package early can cause
% fontspec/font-shape warnings; we handle heuristica only via font detection.
\RequirePackage[hidelinks]{hyperref}
\RequirePackage{geometry}
\geometry{%
    top=3cm,
    bottom=2cm,
    left=3cm,
    right=2cm,
    headheight=15pt
}
\RequirePackage{tikz}
\usetikzlibrary{matrix, positioning, calc}
\RequirePackage{graphicx}

% --- Medir largura do último gráfico incluído ---
% Guardamos a última imagem em uma caixa e a largura em \LastGraphicWidth.
\newsavebox{\unifeiLastGraphicBox}
\newlength{\LastGraphicWidth}
% Auxiliares para medidas de subfiguras
\newlength{\Unifei@CurrentFigureWidth}
\newlength{\Unifei@tmpwd}
% Preserve original \includegraphics and wrap it to measure the box.
\let\Unifei@OldIncludeGraphics\includegraphics
\RequirePackage{xparse}
\RenewDocumentCommand{\includegraphics}{O{} m}{%
    % Save the graphic into a box so we can measure its width and then
    % typeset the same box. Using \sbox avoids double typesetting.
        \sbox{\unifeiLastGraphicBox}{\Unifei@OldIncludeGraphics[#1]{#2}}%
        \setlength{\LastGraphicWidth}{\wd\unifeiLastGraphicBox}%
        \usebox{\unifeiLastGraphicBox}%
}
\RequirePackage{setspace}
\RequirePackage{etoolbox}
\RequirePackage[acronym, symbols, translate=babel]{glossaries}

% Hook to capture the width of the last tabular environment automatically
% so \fonte can align to table left edge as well. Wrapping the tabular
% contents directly can break internal alignment (tabular uses \crcr and
% fragile grouping). Instead, after the tabular finishes we grab the last
% vertical box (the table's vbox) and store it in \unifeiLastGraphicBox,
% then record its width. This avoids reboxing the tabular contents.
% Save original tabular macros so we can wrap the environment safely
\let\Unifei@OldTabular\tabular
\let\Unifei@Oldendtabular\endtabular

% Redefine the tabular environment to capture its typeset result into
% \unifeiLastGraphicBox (via lrbox), record its width, and then typeset
% the saved box. We use xparse to accept the optional positional argument
% (like [t]) and the mandatory column specification.
\RenewDocumentEnvironment{tabular}{o m b}{%
    \begin{lrbox}{\unifeiLastGraphicBox}%
        % Invoke the original tabular begin with or without the optional arg
        \IfNoValueTF{#1}{\Unifei@OldTabular{#2}}{\Unifei@OldTabular[#1]{#2}}%
        % Body of the tabular (captured as #3)
        #3
        % Close the original tabular
        \Unifei@Oldendtabular
    \end{lrbox}%
    % Record width and typeset the captured table box
    \global\setlength{\LastGraphicWidth}{\wd\unifeiLastGraphicBox}%
    \usebox{\unifeiLastGraphicBox}%
}{% end environment (nothing to do)
}

% --- Suporte para longtable: determinar largura usada para legendas/\fonte
% longtable é multi-página e não pode ser reboxado de forma segura. Em vez
% disso, usamos \LTcapwidth (largura de caption/coluna para longtable) quando
% disponível; caso contrário, usamos \linewidth como fallback. Isso permite
% que \fonte alinhe à esquerda na maioria dos casos sem interferir na
% tipografia do longtable.
\AtEndEnvironment{longtable}{%
    % Se \LTcapwidth estiver definido, use-o; senão, fallback para \linewidth
    \@ifundefined{LTcapwidth}{%
        \global\setlength{\LastGraphicWidth}{\linewidth}%
    }{%
        \global\setlength{\LastGraphicWidth}{\LTcapwidth}%
    }%
}

% --- Captura e acumula larguras de subfigure ---
% Quando houver subfiguras dentro de um figure, queremos que \fonte use a
% largura total combinada (soma das larguras dos subfigure). Para isso:
% - Ao entrar em um figure, resetamos o acumulador \Unifei@CurrentFigureWidth
% - Redefinimos o ambiente subfigure para capturar seu argumento de largura
%   (por exemplo 0.45\textwidth), converter em comprimento e somar ao
%   acumulador. Também reboxamos o conteúdo do subfigure para medir/usar
%   de forma segura.
\AtBeginEnvironment{figure}{%
    \setlength{\Unifei@CurrentFigureWidth}{0pt}%
}

% Defer subfigure wrapping until after document preamble so that the
% environment is defined (the user may load subcaption after this package).
\AtBeginDocument{%
    \@ifundefined{subfigure}{%
        % subfigure not defined; do nothing
    }{%
        % Preserve original subfigure begin/end so we can invoke them inside our wrapper
        \let\Unifei@OldSubfigure\subfigure
        \let\Unifei@Oldendsubfigure\endsubfigure

        \RenewDocumentEnvironment{subfigure}{o m b}{%
            % capture the subfigure into a box (so we can safely typeset it later)
            \begin{lrbox}{\unifeiLastGraphicBox}%
                % invoke original subfigure begin (with optional placement #1)
                \IfNoValueTF{#1}{\Unifei@OldSubfigure{#2}}{\Unifei@OldSubfigure[#1]{#2}}%
                % body of the subfigure
                #3
                % close original subfigure
                \Unifei@Oldendsubfigure
            \end{lrbox}%
            % convert the width argument (#2) into a length and add to current figure width
            \setlength{\Unifei@tmpwd}{#2}%
            \global\addtolength{\Unifei@CurrentFigureWidth}{\Unifei@tmpwd}%
            % update LastGraphicWidth to the running total so \fonte will use it
            \global\setlength{\LastGraphicWidth}{\Unifei@CurrentFigureWidth}%
            % typeset the captured subfigure box
            \usebox{\unifeiLastGraphicBox}%
        }{% end subfigure
        }
    }%
}

% Quando o figure terminar, se acumulamos alguma largura, use-a como LastGraphicWidth
\AtEndEnvironment{figure}{%
    \ifdim\Unifei@CurrentFigureWidth>0pt
        \global\setlength{\LastGraphicWidth}{\Unifei@CurrentFigureWidth}%
    \fi
}
\RequirePackage{xstring}
\RequirePackage{indentfirst}
% For proper justified text inside narrow blocks
\RequirePackage{ragged2e}

% Make figure/table/equation numbering continuous across the document
% (do not reset per chapter). Use chngcntr to remove the dependency on
% the chapter counter.
\RequirePackage{chngcntr}
\counterwithout{figure}{chapter}
\counterwithout{table}{chapter}
\counterwithout{equation}{chapter}

% Ensure caption package is available (some documents load subcaption instead);
% configure captions to use a sans-serif font (label bold + sans, text sans).
\RequirePackage{caption}
\captionsetup{font=small,labelfont={bf,sf},textfont={sf}}

% --- Carregamento da fonte Exo2 a partir do subdiretório "Fontes/Exo2" ---
% Define \ExoTwo como família de fonte local se os arquivos estiverem presentes.
\RequirePackage{fontspec}
\newif\ifExoTwoAvailable
\ExoTwoAvailablefalse
% Tenta arquivos .ttf primeiro, depois .otf; usa padrões *-Regular/*-Bold/*-Italic/*-BoldItalic
\IfFileExists{Fontes/Exo2/Exo2-Regular.ttf}{%
    \newfontfamily\ExoTwo[
        Path=Fontes/Exo2/,
        UprightFont = Exo2-Regular.ttf,
        BoldFont    = Exo2-Bold.ttf,
        ItalicFont  = Exo2-Italic.ttf,
        BoldItalicFont = Exo2-BoldItalic.ttf
    ]{Exo2-Regular.ttf}%
    \ExoTwoAvailabletrue
}{%
    \IfFileExists{Fontes/Exo2/Exo2-Regular.otf}{%
        \newfontfamily\ExoTwo[
            Path=Fontes/Exo2/,
            UprightFont = Exo2-Regular.otf,
            BoldFont    = Exo2-Bold.otf,
            ItalicFont  = Exo2-Italic.otf,
            BoldItalicFont = Exo2-BoldItalic.otf
        ]{Exo2-Regular.otf}%
        \ExoTwoAvailabletrue
    }{%
        % Aviso leve se não encontrar as fontes locais
        \PackageWarning{UnifeiICTReport}{Exo2 fonts not found in "Fontes/Exo2/"; skipping local load.}%
    }%
}

% --- Define comando utilitário para aplicar a fonte institucional (Exo2) quando disponível
% Uso: {\unifeifont Texto} ou apenas \unifeifont antes de um grupo.
\providecommand{\unifeifont}{}%
\renewcommand{\unifeifont}{%
    \ifExoTwoAvailable
        \ExoTwo
    \else
        % fallback: não altera (a fonte principal é Libertine)
    \fi
}

% \unifeismallcaps: prefer real OpenType small-caps when available,
% but avoid requesting the feature for the local Exo2 bundle (which does
% not provide small-caps and causes a font shape warning). If Exo2 is
% available, fall back to a simple uppercase (keeps text extraction
% accurate). Otherwise attempt to use OpenType small-caps where present.
\newcommand{\unifeismallcaps}[1]{%
    \ifExoTwoAvailable
        {\unifeifont\MakeUppercase{#1}}%
    \else
        {\unifeifont\addfontfeatures{Letters=SmallCaps}\MakeUppercase{#1}}%
    \fi
}

% --- Configure main font: prefer Heuristica; carregue também fontes matemáticas via unicode-math ---
% fontspec já foi requerido antes; agora garantimos unicode-math disponível.
\RequirePackage{unicode-math}

% Prefer Heuristica como fonte principal quando disponível.
% Se o pacote 'heuristica' foi carregado (fonte clássica Type1 via pacote),
% permitimos que ele defina \rmdefault e evitamos chamar \setmainfont (que tenta
% carregar OpenType pelo nome). Caso contrário, tentamos nomes OpenType comuns.
% Simplified Heuristica detection: try the OpenType family name 'Heuristica'
% directly (many TeXLive installations provide it under this name). Avoid
% probing legacy names such as 'Heuristica-TLF' which can trigger mktextfm
% attempts and noisy warnings when the legacy shape files are not present.
\IfFontExistsTF{Heuristica}{%
    \setmainfont{Heuristica}[Ligatures=TeX,Scale=MatchLowercase]
}{%
    % fallback chain when Heuristica OpenType not available
    \PackageWarning{UnifeiICTReport}{Main system font "Heuristica" not found; attempting fallbacks (Libertinus Serif, TeX Gyre Termes).}
    \IfFontExistsTF{Libertinus Serif}{%
        \setmainfont{Libertinus Serif}[Ligatures=TeX,Scale=MatchLowercase]
    }{%
        \IfFontExistsTF{TeX Gyre Termes}{%
            \setmainfont{TeX Gyre Termes}[Ligatures=TeX,Scale=MatchLowercase]
        }{%
            \PackageWarning{UnifeiICTReport}{No preferred main fonts (Heuristica/Libertinus/TeX Gyre Termes) found; leaving default font.}
        }
    }
}

% Escolha de fonte matemática (prioridade): Heuristica Math -> Libertinus Math -> TeX Gyre Pagella Math -> Latin Modern Math -> Asana Math
\IfFontExistsTF{Heuristica Math}{%
    \setmathfont{Heuristica Math}
}{%
    \IfFontExistsTF{Libertinus Math}{%
        \setmathfont{Libertinus Math}
    }{%
        \IfFontExistsTF{TeX Gyre Pagella Math}{%
            \setmathfont{TeX Gyre Pagella Math}
        }{%
            \IfFontExistsTF{Latin Modern Math}{%
                \setmathfont{Latin Modern Math}
            }{%
                % último recurso
                \setmathfont{Asana Math}
            }
        }
    }
}

% --- Fonte monoespaçada ---
% Prefer IBM Plex Mono usando o nome de família que o TeXLive registra
% (por exemplo "IBM Plex Mono"). Não sondamos "plex-otf" para evitar que
% mktextfm seja chamado em instalações que exponham o pacote sob nomes
% diferentes.
\IfFontExistsTF{IBM Plex Mono}{%
    \setmonofont{IBM Plex Mono}[Scale=MatchLowercase]
}{%
    \IfFontExistsTF{IBMPlexMono}{%
        \setmonofont{IBMPlexMono}[Scale=MatchLowercase]
    }{%
        \IfFontExistsTF{Inconsolata}{%
            \setmonofont{Inconsolata}[Scale=MatchLowercase]
        }{%
            \IfFontExistsTF{Latin Modern Mono}{%
                \setmonofont{Latin Modern Mono}[Scale=MatchLowercase]
            }{%
                % nada a fazer; usará a monofont padrão do sistema
                \PackageWarning{UnifeiICTReport}{No preferred monospaced fonts found (IBM Plex Mono/Inconsolata/Latin Modern Mono); leaving default monospace.}
            }
        }
    }
}

% --- Formatação de títulos com titlesec: usar Exo2 (\unifeifont) nos títulos ---
% Removemos o uso direto de \pretocmd (que aplicava \unifeifont globalmente) e
% configuramos titlesec para aplicar \unifeifont apenas aos rótulos/títulos.
\RequirePackage{titlesec}

% --- Header / page number handling: place page number at outer top and
% start counting on the cover but show numbers only from the first chapter ---
\RequirePackage{fancyhdr}

\fancypagestyle{plain}{
    \addtolength{\footskip}{0.6cm}
    \fancyhf{}
    \renewcommand{\headrulewidth}{0pt}


    \if@twoside
        \fancyhead[LE, RO]{\thepage}
    \else
        \fancyhead[R]{\thepage}
    \fi
}

\pagestyle{fancy}
\addtolength{\footskip}{0.6cm}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}

\if@twoside
    \fancyhead[LE, RO]{\thepage}
\else
    \fancyhead[R]{\thepage}
\fi

\newcommand{\conditionalvspace}[2]{%
    \if\relax\detokenize{#1}\relax
        % Do nothing if the argument is empty
    \else
        {#1}\vspace{#2}%
    \fi
}

% --- Defaults ---
\newcommand{\@subtitle}{}
\providecommand{\subtitle}[1]{\renewcommand{\@subtitle}{#1}}
\newcommand{\@institution}{Universidade Federal de Itajubá}
\providecommand{\institution}[1]{\renewcommand{\@institution}{#1}}
\newcommand{\@faculty}{Instituto de Ciências Tecnológicas}
\providecommand{\faculty}[1]{\renewcommand{\@faculty}{#1}}
\newcommand{\@course}{Engenharia de Computação}
\providecommand{\course}[1]{\renewcommand{\@course}{#1}}
\newcommand{\@location}{Itabira}
\providecommand{\location}[1]{\renewcommand{\@location}{#1}}
\newcommand{\@state}{Minas Gerais}
\providecommand{\state}[1]{\renewcommand{\@state}{#1}}
\newcommand{\@stateacronym}{MG}
\providecommand{\stateacronym}[1]{\renewcommand{\@stateacronym}{#1}}

% Metadados do documento (compatíveis com book)
\newcommand{\@subject}{}
\providecommand{\subject}[1]{\renewcommand{\@subject}{#1}}
\newcommand{\@supervisor}{}
% flag indicating whether a supervisor name was provided (non-empty)
\newif\if@supervisorpresent\@supervisorpresentfalse
\providecommand{\supervisor}[1]{\renewcommand{\@supervisor}{#1}%
    \ifblank{#1}{\@supervisorpresentfalse}{\@supervisorpresenttrue}%
}
\newcommand{\@cosupervisor}{}
% flag indicating whether a co-supervisor name was provided (non-empty)
\newif\if@cosupervisorpresent\@cosupervisorpresentfalse
\providecommand{\cosupervisor}[1]{\renewcommand{\@cosupervisor}{#1}%
    \ifblank{#1}{\@cosupervisorpresentfalse}{\@cosupervisorpresenttrue}%
}

\newcommand{\@abstract}{}
\providecommand{\abstract}[1]{\renewcommand{\@abstract}{#1}}
\newcommand{\@abstractseclang}{}
\providecommand{\abstractseclang}[1]{\renewcommand{\@abstractseclang}{#1}}
\newcommand{\@keywords}{}
\providecommand{\keywords}[1]{\renewcommand{\@keywords}{#1}}
\newcommand{\@keywordsseclang}{}
\providecommand{\keywordsseclang}[1]{\renewcommand{\@keywordsseclang}{#1}}

%-----------------
% TRADUÇÕES
%-----------------
\newcommand{\figuresourcename}{Source} % Padrão em inglês
\addto\captionsbrazilian{\renewcommand{\figuresourcename}{Fonte}}
\addto\captionsspanish{\renewcommand{\figuresourcename}{Fuente}} % Tradução para espanhol
\addto\captionsfrench{\renewcommand{\figuresourcename}{Source}}  % Tradução para francês
\addto\captionsgerman{\renewcommand{\figuresourcename}{Quelle}} % Tradução para alemão
\newcommand{\acronymlistname}{List of Acronyms} % Padrão em inglês
\addto\captionsbrazilian{\renewcommand{\acronymlistname}{Lista de Abreviaturas e Siglas}}
\addto\captionsspanish{\renewcommand{\acronymlistname}{Lista de Acrónimos}} % Tradução para espanhol
\addto\captionsfrench{\renewcommand{\acronymlistname}{Liste des Acronymes}}  % Tradução para francês
\addto\captionsgerman{\renewcommand{\acronymlistname}{Acronym-Liste}} % Tradução para alemão
\newcommand{\symbolslistname}{List of Symbols} % Padrão em inglês
\addto\captionsbrazilian{\renewcommand{\symbolslistname}{Lista de Símbolos}}
\addto\captionsspanish{\renewcommand{\symbolslistname}{Lista de Símbolos}} % Tradução para espanhol
\addto\captionsfrench{\renewcommand{\symbolslistname}{Liste des Symboles}}  % Tradução para francês
\addto\captionsgerman{\renewcommand{\symbolslistname}{Symbol-Liste}} % Tradução para alemão

% Cores institucionais
\definecolor{unifeiblue}{cmyk}{1, 0.7, 0.1, 0.45}
\definecolor{unifeired}{cmyk}{0, 0.95, 1, 0}
\definecolor{unifeimedgrey}{cmyk}{0.2, 0.1, 0.1, 0.25}
\definecolor{unifeilightgrey}{cmyk}{0.05, 0.03, 0.03, 0.05}

% Linha horizontal utilitária
\newcommand{\HRule}{\rule{\linewidth}{0.5mm}}
% \newcommand{\hrule}{\rule{\linewidth}{0.2mm}}

\renewcommand{\baselinestretch}{1.5}

\providecommand{\refcomp}[2]{\hyperref[#2]{\color{unifeiblue}{\textbf{#1~\ref*{#2} - \nameref*{#2}}}}}

% Nomes para referências tipo equação e suas traduções
\newcommand{\eqname}{Equation}
\addto\captionsbrazilian{\renewcommand{\eqname}{Equação}}
\addto\captionsspanish{\renewcommand{\eqname}{Ecuación}}
\addto\captionsfrench{\renewcommand{\eqname}{Équation}}
\addto\captionsgerman{\renewcommand{\eqname}{Gleichung}}

% Wrappers específicos para figuras, tabelas e equações usando o formato de \refcomp
% Uso: \reffig{<label>}, \reftable{<label>}, \refeq{<label>}
\providecommand{\reffig}[1]{\hyperref[#1]{\color{unifeiblue}\figurename~\ref{#1}}}
\providecommand{\reftable}[1]{\hyperref[#1]{\color{unifeiblue}\tablename~\ref{#1}}}
\providecommand{\refeq}[1]{\hyperref[#1]{\color{unifeiblue}\eqname~\ref{#1}}}
\providecommand{\reffigcomp}[1]{\refcomp{\figurename}{#1}}
\providecommand{\reftablecomp}[1]{\refcomp{\tablename}{#1}}
% \refeqcomp: accept a mandatory label and an optional custom name for the equation.
% Usage: \refeqcomp{<label>} or \refeqcomp{<label>}[<custom name>]
\NewDocumentCommand{\refeqcomp}{m o}{%
    \IfNoValueTF{#2}{%
        % no custom name: use the localized \eqname via \refcomp
        \refcomp{\eqname}{#1}%
    }{%
        % custom name provided: build same formatted hyperref but with the
        % provided name instead of \nameref*{#1}
        \hyperref[#1]{\color{unifeiblue}{\textbf{\eqname~\ref*{#1} - #2}}}%
    }%
}

% Redefine \quote to accept two parameters: bibliographic key and quoted text.
% Appearance:
% - Use the main document font (set via \setmainfont)
% - One size smaller than normal (\small)
% - Justified inside the quoted block (\justifying)
% - The quoted block is flush right and has a left indent of 4cm
% - The citation (\cite{<key>}) appears right-aligned inside the block
% Usage: \quote{<bibkey>}{<quoted text>}
\DeclareRobustCommand{\quote}[2]{%
    \par\bigskip%
    \noindent\hfill% push the box to the right
    \begin{minipage}{\dimexpr\linewidth-4cm\relax}% width reduced by 4cm
        {\normalsize\small% no indent, one size below normal
        \justifying\noindent #2\par% quoted text, justified
        \vspace{0.1\baselineskip}% small gap
        \hfill\raggedright{\footnotesize\cite{#1}}% citation right-aligned within the block
        }%
    \end{minipage}%
    \par\bigskip%
}

\providecommand{\fonte}[1]{%
    % Place the source text aligned to the left edge of the last included
    % graphic while matching caption styling: small size, sans-serif text
    % and label in bold sans-serif (same as \captionsetup{labelfont={bf,sf},textfont={sf}}).
    \par\vspace{2pt}% small gap after the figure
    {\small\sffamily% caption uses small + sans
        % If \LastGraphicWidth hasn't been set (no previous graphic), fall back
        % to full line width (left-aligned).
        \ifdim\LastGraphicWidth=0pt
            \makebox[\linewidth][l]{\textbf{\figuresourcename:}~#1.}\par
        \else
            % center an inner box of width \LastGraphicWidth and left-align
            % the source inside it so it sits at the left edge of the graphic
            \makebox[\linewidth][c]{% centered relative to the text block
                \makebox[\LastGraphicWidth][l]{\textbf{\figuresourcename:}~#1.}%
            }\par
        \fi
    }
}

%-------------------------------------------------
% CAPA E FOLHA DE ROSTO
%-------------------------------------------------
\renewcommand{\maketitle}{%
    % \pagenumbering{gobble}
    %----------------------------
    %   Capa
    %----------------------------
    \clearpage\thispagestyle{empty}
    {
        \setstretch{1.0}
        \begin{tikzpicture}[remember picture,overlay]
            \fill[unifeired] (current page.north west) rectangle ($(current page.south west) + (0.3cm, 0)$);
            \fill[unifeimedgrey] ($(current page.north west) + (0.3cm, 0)$) rectangle ($(current page.south west) + (0.9cm, 0)$);
            \fill[unifeiblue] ($(current page.north west) + (0.9cm, 0)$) rectangle ($(current page.south west) + (1.2cm, 0)$);
            \node[yslant=0.7, opacity=0.25] at ($(current page.center) + (5cm, -3cm)$) {\includegraphics[width=25cm]{Logos/simbolo_PANTONE}};
        \end{tikzpicture}
        \centering
        % Logo da instituição
        {\noindent\includegraphics[width=3cm]{Logos/simbolo_PANTONE}\par}
        \bigskip
        % Universidade
        {\color{unifeiblue}\unifeismallcaps{\LARGE\bfseries\@institution}\par}
        \vspace{1cm}
        {\large\@author\par}
        \vfill
        \begin{minipage}{\textwidth}
            \centering
            {\unifeifont\color{unifeiblue}\Huge\bfseries\@title\par}
            \ifcsdef{@subtitle}{%
                \ifdefempty{\@subtitle}{}%
                {%
                    {\setstretch{1.0}\par\vspace{1cm}\LARGE\unifeifont\@subtitle}%
                }
            }{}
        \end{minipage}
        \vfill\vfill
        {\unifeifont\large\parbox{\textwidth}{\centering\MakeUppercase{\@location}\par\the\year}\par}
    }
    \if@openright
        \cleardoublepage
    \else
        \clearpage
    \fi
    %------------------------------------------------
    % Folha de rosto
    %------------------------------------------------
    \begin{titlepage}
        \thispagestyle{empty}
        \setcounter{page}{1}%
        \centering % Centre everything on the page
        \setstretch{1.0}
        %------------------------------------------------
        %	Cabeçalhos
        %------------------------------------------------
        % Universidade
        {\color{unifeiblue}\unifeismallcaps{\Large\@institution}\\}\smallskip
        % Faculdade
        {\unifeifont\large{\@faculty}\\}\smallskip
        % Curso
        {\unifeifont\@course\\}\vspace{1cm}
        \vfill
        %------------------------------------------------
        %	Título e subtítulo
        %------------------------------------------------
        \begin{minipage}{\textwidth}
            \centering
            % Réguas
            {\color{unifeiblue}\hrule width \hsize height 2pt \kern 0.5mm \color{unifeired}\hrule width \hsize}
            \vspace{5mm}
            % Título
            {\setstretch{1.0}\LARGE\bfseries\color{unifeiblue}\unifeifont\@title\par}
            % Subtítulo (opcional)
            \ifcsdef{@subtitle}{%
                \ifdefempty{\@subtitle}{%
                    \vspace{5mm}
                }{%
                    {\setstretch{1.0}\par\vspace{5mm}\Large\unifeifont\@subtitle\vspace{5mm}}%
                }
            }{}
            % Réguas
            {\color{unifeired}\hrule width \hsize \kern 0.5mm \color{unifeiblue}\hrule width \hsize height 2pt}
            \vspace{1cm}

            %------------------------------------------------
            %	Autor(es) e orientador(es)
            %------------------------------------------------

            \parbox{\textwidth}{
                \begin{minipage}[t]{0.40\textwidth}
                    \setstretch{1.0}
                    \begin{flushleft}
                        \large
                        % Determine whether to use 'Autor' or 'Autores'
                        \begingroup
                        \edef\UnifeiICTReport@authdetok{\detokenize\expandafter{\@author}}%
                        \IfSubStr{\UnifeiICTReport@authdetok}{\string\\}{{\color{unifeiblue}\unifeismallcaps{\Large Autores}}}{{\color{unifeiblue}\unifeismallcaps{\Large Autor}}}\\
                        \vspace{0.25\baselineskip}
                        % print the provided author(s)
                        \large\@author
                        \endgroup
                    \end{flushleft}
                \end{minipage}
                ~
                % Supervisor box: only print if a supervisor name was provided.
                % We rely on the boolean \if@supervisorpresent set when \supervisor{...}
                % is invoked; this avoids false positives if \@supervisor gets populated
                % with invisible tokens by other processing.
                \if@supervisorpresent
                    \hfill%
                    \begin{minipage}[t]{0.40\textwidth}
                        \setstretch{1.0}
                        \begin{flushright}
                            {\color{unifeiblue}\unifeismallcaps{\Large Orientador}}\\
                            \vspace{0.25\baselineskip}
                            \large\@supervisor
                            \if@cosupervisorpresent
                                \par\vspace{0.5em}{\color{unifeiblue}\unifeismallcaps{\Large Coorientador}}\\
                                \vspace{0.25\baselineskip}
                                \large\@cosupervisor
                            \fi
                        \end{flushright}
                    \end{minipage}
                \fi
            }%
        \end{minipage}
        \vfill\vfill%
        \hfill%
        \begin{parbox}{0.5\textwidth}{
                \setstretch{1.0}
                \normalsize
                Relatório apresentado ao professor da disciplina de \@subject, como requisito parcial para aprovação no semestre.
            }
        \end{parbox}
        \vfill\vfill\vfill%
        %------------------------------------------------
        %	Logos no rodapé
        %------------------------------------------------
        \begin{minipage}{0.45\textwidth}
            \begin{flushleft} \includegraphics[width=0.8\textwidth]{Logos/assin_hor_PANTONE_pos}
            \end{flushleft}
        \end{minipage}
        \begin{minipage}{0.45\textwidth}
            \begin{flushright} \includegraphics[width=0.7\textwidth]{Logos/assin_hor_ICT}
            \end{flushright}
        \end{minipage}\\[.5 cm]
        {\large\parbox{\textwidth}{\centering\@location,~\@state,~\today}\par} % Data da compilação
    \end{titlepage}
    \if@openright
        \cleardoublepage
    \else
        \clearpage
    \fi
}

%----------------------------
%   IMPRIMIR OS RESUMOS
%----------------------------
\providecommand{\makeabstracts}{%
    \thispagestyle{empty}
    % Resumo title: center properly (usar mesma aparência dos títulos)
    {\centering\large\bfseries\unifeifont\color{unifeiblue}\MakeUppercase{Resumo}\par}
    \vspace{1.5cm}
    % abstract body (normal paragraph formatting)
    {\par\normalsize\setstretch{1.5}\@abstract\par}
    \vspace{0.5\baselineskip}
    {\par\noindent\textbf{Palavras-chave:} \@keywords\par}
    \vfill
    \if@openright
        \cleardoublepage
    \else
        \clearpage
    \fi
    %----------------------------
    %   ABSTRACT (SECOND LANGUAGE)
    %----------------------------
    \thispagestyle{empty}
    % Abstract title: center properly (usar mesma aparência dos títulos)
    {\centering\large\bfseries\unifeifont\color{unifeiblue}\MakeUppercase{Abstract}\par}
    \vspace{1.5cm}
    % abstract body (normal paragraph formatting)
    {\par\normalsize\setstretch{1.5}\@abstractseclang\par}
    \vspace{0.5\baselineskip}
    {\par\noindent\textbf{Keywords:} \@keywordsseclang\par}
    \vfill
    \if@openright
        \cleardoublepage
    \else
        \clearpage
    \fi
}

% Capítulo: "Número~NomeCapítulo" no mesmo parágrafo
\titleformat{\chapter}[hang]{\unifeifont\color{unifeiblue}\Large\bfseries\MakeUppercase}{\thechapter}{0.5em}{}
\titlespacing*{\chapter}{0pt}{20pt}{10pt}
% Seções/subseções também usam a fonte institucional nos rótulos
\titleformat{\section}[hang]{\unifeifont\color{unifeiblue}\large\bfseries}{\thesection}{0.5em}{}
\titleformat{\subsection}[hang]{\unifeifont\color{unifeiblue}\large}{\thesubsection}{0.5em}{}
\titleformat{\subsubsection}[hang]{\unifeifont\color{unifeiblue}\normalsize}{\thesubsubsection}{1em}{}

% Redefine table of contents title to match chapter title styling
\renewcommand{\tableofcontents}{%
    \cleardoublepage
        	\thispagestyle{empty}% use plain pagestyle (page number placement)
    % Title styled like chapter titles: institutional font, color and uppercase
    {\centering\unifeifont\color{unifeiblue}\large\bfseries\MakeUppercase{\contentsname}\par}
    \vspace{1em}% small gap before the contents
    \@starttoc{toc}% actual TOC
    \if@openright\cleardoublepage\else\clearpage\fi
}

% Apply same styling to List of Figures
\renewcommand{\listoffigures}{%
    \cleardoublepage
    \thispagestyle{empty}
    {\centering\unifeifont\color{unifeiblue}\large\bfseries\MakeUppercase{\listfigurename}\par}
    \vspace{1em}
    \@starttoc{lof}
    \if@openright\cleardoublepage\else\clearpage\fi
}

% Apply same styling to List of Tables
\renewcommand{\listoftables}{%
    \cleardoublepage
    \thispagestyle{empty}
    {\centering\unifeifont\color{unifeiblue}\large\bfseries\MakeUppercase{\listtablename}\par}
    \vspace{1em}
    \@starttoc{lot}
    \if@openright\cleardoublepage\else\clearpage\fi
}

% Center and style glossary titles to match the document's pretext headings
% Redefine \glossarysection to accept an optional TOC title (first arg)
% and a mandatory printed title (second arg). Use the TOC title for
% running heads when provided, otherwise fall back to the printed title.
\renewcommand*{\glossarysection}[2][]{%
    \cleardoublepage
    	\thispagestyle{empty}%
    {\centering\unifeifont\color{unifeiblue}\large\bfseries\MakeUppercase{#2}\par}%
    \vspace{1em}%
    % choose running head: optional arg #1 if not empty, else printed title #2
    \ifdefempty{#1}{\markboth{#2}{#2}}{\markboth{#1}{#1}}%
}

\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{3}

% ------------------------------------------------------------------
% Formatação das entradas do Sumário (ToC)
% Capítulos: \unifeifont, large, bold, uppercase
% Seções: normalfont, large, bold
% Subseções: normalsize, normalfont, sem bold
% Subsubseções: normalsize, normalfont, itálico
% Observação: evitamos criar novos comandos com nomes iniciados em "\t"
% (problema conhecido). Redefinimos as macros locais \l@... usadas pelo
% mecanismo de escrita do .toc.
\renewcommand{\l@chapter}[2]{%
    \ifnum \c@tocdepth>\m@ne
        \addpenalty{-\@highpenalty}%
        \vskip 1.0em \@plus\p@%
        % capítulos sem recuo lateral, número/reserva pequena
        \@dottedtocline{0}{0em}{1.5em}{% title
            {\unifeifont\color{unifeiblue}\normalsize\bfseries\MakeUppercase{#1}}%
        }{#2}% page
    \fi
}

\renewcommand{\l@section}[2]{%
    \ifnum \c@tocdepth>\z@
        \addpenalty{-\@highpenalty}%
        % recuo das seções um pouco menor
        \@dottedtocline{1}{1.0em}{2.0em}{% title
            {\unifeifont\color{unifeiblue}\normalsize\bfseries #1}%
        }{#2}% page
    \fi
}

\renewcommand{\l@subsection}[2]{%
    \ifnum \c@tocdepth>\tw@
        \addpenalty{-\@highpenalty}%
        % recuo das subseções reduzido
        \@dottedtocline{2}{2.2em}{2.6em}{% title
            {\unifeifont\color{unifeiblue}\normalsize #1}%
        }{#2}% page
    \fi
}

\renewcommand{\l@subsubsection}[2]{%
    % mostrar subsubsections quando tocdepth > 2 (i.e., tocdepth>=3)
    \ifnum \c@tocdepth>\tw@
        \addpenalty{-\@highpenalty}%
        % recuo das subsubseções reduzido
        \@dottedtocline{3}{4.0em}{3.2em}{% title
            {\unifeifont\color{unifeiblue}\normalsize\itshape #1}%
        }{#2}% page
    \fi
}

% 1. Redefinir o \frontmatter
\renewcommand\frontmatter{
    \cleardoublepage
    \@mainmatterfalse % Mantém os capítulos como \chapter*
    \pagenumbering{arabic} % <-- MUDANÇA: Inicia com números arábicos
    \pagestyle{empty}      % <-- ADIÇÃO: Esconde os números de página
}

% 2. Redefinir o \mainmatter
\renewcommand\mainmatter{
    \cleardoublepage
    \@mainmattertrue  % Habilita capítulos numerados (\chapter)
    % A linha \pagenumbering{arabic} foi REMOVIDA daqui
    % para impedir que o contador seja reiniciado.
    \pagestyle{plain} % <-- ADIÇÃO: Torna os números visíveis
}

\endinput
